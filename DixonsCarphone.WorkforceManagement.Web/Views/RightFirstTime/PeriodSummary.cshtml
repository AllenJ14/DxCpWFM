@model DixonsCarphone.WorkforceManagement.ViewModels.BusinessModels.RFTPPeriodSummaryVm

@{
    ViewBag.Title = "Period Summary";
}

<div class="row">
    &emsp;
</div>

<div class="panel panel-default">
    <div class="panel-heading text-center">
        <strong>RFTP Non-Compliance</strong>
    </div>
    <div class="panel-body">
        <p>
            Bacon ipsum dolor amet leberkas drumstick flank cow, ribeye meatloaf filet mignon jowl ham fatback salami chuck turducken andouille pork belly. Pork pastrami corned beef landjaeger bacon spare ribs chuck tongue ham jerky picanha ribeye kielbasa meatball tenderloin. Boudin shankle capicola cupim pork shoulder beef ribs kevin frankfurter pig pancetta landjaeger hamburger kielbasa pork loin. Kielbasa tenderloin frankfurter buffalo doner salami pork belly strip steak corned beef leberkas chuck. Swine chicken beef ribs ribeye cupim ball tip. Pork shoulder chuck andouille, ham rump meatball meatloaf jerky. Short ribs hamburger pork loin ham, drumstick kielbasa t-bone.
        </p>
    </div>
</div>

<div class="panel panel-default">
    <div class="panel-body" style="min-height:500px;">
        <div class="table-responsive">
            <table class="table table-bordered table-condensed">
                <thead>
                    <tr>
                        <th class="text-center" rowspan="2" style="vertical-align:middle;">Manager</th>
                        <th class="text-center" rowspan="2" style="vertical-align:middle;">Issue Store</th>
                        <th class="text-center" rowspan="2" style="vertical-align:middle;"></th>
                        <th class="text-center" colspan="3">Actions Required</th>
                    </tr>
                    <tr>
                        <th class="col-xs-1 text-center">RM</th>
                        <th class="col-xs-1 text-center">TPC</th>
                        <th class="col-xs-1 text-center">WFM</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.Cases.OrderBy(x => x.PersonName))
                    {
                        <tr>
                            <td>@item.PersonName</td>
                            <td class="text-center">@item.StoreNumber</td>
                            <td class="text-center">
                                @if (!item.Confirmed)
                                {
                                    <div class="btn-group visible-lg-inline-block" role="group">
                                        <button type="button" data-toggle="modal" data-target="#rModal" data-caseid="@item.CaseID" class="btn btn-default">Reassign</button>
                                        <button type="button" data-toggle="modal" data-target="#cModal" data-caseid="@item.CaseID" data-name="@item.PersonName" class="btn btn-success">Confirm</button>
                                    </div>
                                    <div class="btn-group hidden-lg">
                                        <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">Action required... <span class="caret"></span></button>
                                        <ul class="dropdown-menu">
                                            <li><a href="#" data-toggle="modal" data-target="#oModal" data-caseid="@item.CaseID">Reassign</a></li>
                                            <li role="separator" class="divider"></li>
                                            <li><a href="#" data-toggle="modal" data-target="#cModal" data-caseid="@item.CaseID" data-name="@item.PersonName">Confirm</a></li>
                                        </ul>
                                    </div>
                                }
                                else if(!item.Override)
                                {
                                    <button type="button" data-toggle="modal" data-target="#oModal" data-caseid="@item.CaseID" class="btn btn-warning">Override</button>
                                }
                                else
                                {
                                    <strong><u>Overridden</u></strong>
                                }
                            </td>
                            @if (item.Confirmed)
                            {
                                var actionsNeeded = Model.Actions.Where(x => x.Stage == item.Stage);
                                <td>
                                    @if (actionsNeeded.Where(x => x.Owner == "RM").Count() > 0)
                                    {
                                        <span class="btn btn-info" style="width:100%;">@actionsNeeded.Where(x => x.Owner == "RM").First().ActionType</span>
                                    }
                                </td>
                                <td>
                                    @if (actionsNeeded.Where(x => x.Owner == "TPC").Count() > 0)
                                    {
                                        <span class="btn btn-info" style="width:100%;">@actionsNeeded.Where(x => x.Owner == "TPC").First().ActionType</span>
                                    }
                                </td>
                                <td>
                                    @if (actionsNeeded.Where(x => x.Owner == "WFM").Count() > 0)
                                    {
                                        <span class="btn btn-info" style="width:100%;">@actionsNeeded.Where(x => x.Owner == "WFM").First().ActionType</span>
                                    }
                                </td>
                            }
                            else
                            {
                                <td></td>
                                <td></td>
                                <td></td>
                            }                            
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="rModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="rModalLabel">Reassign to Manager</h4>
            </div>
            <div class="modal-body">
                <form action="/RightFirstTime/caseReassign" method="post">
                    <input id="rCaseID" name="caseID" hidden value="e" />
                    <div class="form-group">
                        <label for="rEmpNumber" style="display:block;">Manager</label>
                        @Html.DropDownList("empNumber", Model.ManagerDropdown, new { @class="form-control", style="display: inline-block; width: 80%;"})
                        <button type="button" id="rSearchBtn" class="btn btn-info"><span class="glyphicon glyphicon-search"></span></button>
                    </div>
                    <div id="rSearchCont" style="display:none;">
                        <input style="display: inline-block; width: 80%;" type="text" class="form-control" id="rSearchCrit" placeholder="Search by name..." />
                        <button type="button" id="rSearchSubmit" class="btn btn-info">Search</button>
                        <div id="searchResult" class="table-responsive" style="max-height:300px; margin:10px 0px;"></div>
                    </div>
                    <div class="form-group">
                        <label for="rComment">Comment</label>
                        <textarea id="rComment" name="comment" class="form-control" rows="3" style="resize:vertical;"></textarea>
                    </div>
                    <hr />
                    <div class="text-center">
                        <button type="submit" class="btn btn-success">Save Changes</button>
                        <button type="button" data-dismiss="modal" class="btn btn-danger">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="oModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="oModalLabel">Override</h4>
            </div>
            <div class="modal-body">
                <form action="/RightFirstTime/caseOverride" method="post">
                    <input id="oCaseID" name="caseID" hidden value="e" />
                    <div class="form-group">
                        <label for="oReason">Reason</label>
                        <select id="oReason" name="reason" class="form-control">
                            <option>Responsible manager left business</option>
                            <option>Exceptional circumstance (please specify)</option>
                        </select>
                    </div>
                    <div class="form-group" id="oCommentContainer" style="display:none;">
                        <label for="oComment">Comment</label>
                        <textarea id="oComment" name="comment" class="form-control" rows="3"></textarea>
                    </div>
                    <hr />
                    <div class="text-center">
                        <button type="submit" class="btn btn-success">Save Changes</button>
                        <button type="button" data-dismiss="modal" class="btn btn-danger">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="cModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="cModalLabel">Confirm</h4>
            </div>
            <div class="modal-body">
                <form action="/RightFirstTime/caseConfirm" method="post">
                    <input id="cCaseID" name="caseID" hidden value="e" />
                    <h4>Confirm this case is for <strong><u id="cName">Joe Bloggs</u></strong></h4>
                    <hr />
                    <div class="text-center">
                        <button type="submit" class="btn btn-success">Confirm</button>
                        <button type="button" data-dismiss="modal" class="btn btn-danger">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section myScripts{
    <script>
        $(document).on('keyup keypress', 'form input[type="text"]', function (e) {
            if (e.keyCode == 13) {
                e.preventDefault();
                return false;
            }
        });

        $(function () {
            $('#rModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget);
                var id = button.data('caseid');
                
                var modal = $(this);
                modal.find('#rCaseID').val(id);
            });

            $('#oModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget);
                var id = button.data('caseid');
                
                var modal = $(this);
                modal.find('#oCaseID').val(id);
            });

            $('#cModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget);
                var id = button.data('caseid');
                var name = button.data('name');
                console.log(id);
                var modal = $(this);
                modal.find('#cCaseID').val(id);
                modal.find('#cName').html(name);
            });

            $('#rSearchBtn').on('click', function () {
                $('#rSearchCont').slideDown();
            });

            $('#rSearchSubmit').on('click', function () {
                var criteria = $('#rSearchCrit').val();
                $.get('/RightFirstTime/_employeeSearch', { crit: criteria }, function (result) {
                    setTimeout(function () {
                        $('#searchResult').html(result);
                    }, 250);
                });
            });

            $('#rSearchCont').on('click', '.rSelected', function () {
                var name = $(this).data('name');
                var number = $(this).data('number');

                $('#rEmpNumber').prepend('<option value="' + number + '">' + name + '</option>')
                $('#rEmpNumber').val(number).change();

                $('#rSearchCont').slideUp();
                $('#rSearchCrit').val('');
                $('#searchResult').html('');
            });
        });
    </script>
}